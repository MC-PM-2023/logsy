{% extends "base.html" %}
{% block title %}Team Timesheet Logs{% endblock %}

{% block content %}
<style>
  /* --- Global & Scrollbar --- */
  :root {
    --bg: #050505; --card: #101010; --card-border: #222;
    --text: #e0e0e0; --muted: #777; --accent: #ffd700; /* Gold Accent */
    --accent-glow: rgba(255, 215, 0, 0.15);
    --input-bg: #1a1a1a; --danger: #ff4d4d; --success: #00cc66;
  }

  body { background-color: var(--bg); color: var(--text); font-family: 'Inter', sans-serif; overflow-x: hidden; }

  /* Custom Scrollbar */
  ::-webkit-scrollbar { width: 8px; height: 8px; }
  ::-webkit-scrollbar-track { background: var(--bg); }
  ::-webkit-scrollbar-thumb { background: #333; border-radius: 4px; }
  ::-webkit-scrollbar-thumb:hover { background: var(--accent); }

  /* --- Main Container --- */
  .wrap { max-width: 98%; margin: 20px auto; animation: fadeIn 0.4s ease-in-out; }
  
  .card {
    background: var(--card); border: 1px solid var(--card-border);
    border-radius: 12px; box-shadow: 0 20px 50px rgba(0,0,0,0.5);
    display: flex; flex-direction: column; height: 88vh;
    overflow: hidden;
  }

  /* --- Header Section --- */
  .head {
    padding: 20px 25px; border-bottom: 1px solid var(--card-border);
    background: linear-gradient(90deg, rgba(255,215,0,0.05) 0%, transparent 100%);
    display: flex; justify-content: space-between; align-items: center;
  }
  .head h2 { margin: 0; color: var(--accent); font-weight: 800; text-transform: uppercase; letter-spacing: 1px; font-size: 1.4rem; text-shadow: 0 0 10px var(--accent-glow); }
  .head .sub { color: var(--muted); font-size: 0.85rem; margin-top: 4px; }

  /* --- Filters Toolbar --- */
  .toolbar { padding: 15px 25px; background: #0c0c0c; border-bottom: 1px solid var(--card-border); }
  .filter-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(130px, 1fr)); gap: 12px; align-items: end; }
  
  .fg label { display: block; font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.5px; color: var(--muted); margin-bottom: 5px; font-weight: 600; }
  
  /* --- IMPROVED DROPDOWN STYLING --- */
  .f-control {
    width: 100%; 
    background-color: var(--input-bg); 
    border: 1px solid #333; 
    color: #fff;
    padding: 8px 12px; 
    border-radius: 6px; 
    font-size: 0.9rem; 
    transition: 0.2s; 
    outline: none;
    cursor: pointer;
    /* Custom Arrow for Selects */
    appearance: none;
    -webkit-appearance: none;
    background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23ffd700' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
    background-repeat: no-repeat;
    background-position: right 10px center;
    background-size: 14px;
  }
  
  /* Remove arrow from inputs that are NOT selects */
  input.f-control { background-image: none; }

  .f-control:focus { border-color: var(--accent); box-shadow: 0 0 0 2px var(--accent-glow); }
  
  .btn-filter { background: var(--accent); color: #000; font-weight: 700; border: none; cursor: pointer; text-align: center; }
  .btn-filter:hover { background: #e6c200; box-shadow: 0 0 15px var(--accent-glow); }
  .btn-reset { background: transparent; border: 1px solid #444; color: var(--muted); text-align: center; display: flex; align-items: center; justify-content: center;}
  .btn-reset:hover { border-color: var(--text); color: var(--text); }

  /* --- Table Area (Sticky Header + Sticky First Col) --- */
  .table-wrap {
    flex: 1; overflow: auto; position: relative;
  }

  table { width: 100%; border-collapse: separate; border-spacing: 0; white-space: nowrap; }

  /* 1. Sticky Header */
  thead th {
    position: sticky; top: 0; z-index: 20;
    background: #181818; 
    color: var(--accent); border-bottom: 2px solid #333;
    padding: 12px 15px; text-align: left; font-size: 0.8rem; text-transform: uppercase; letter-spacing: 0.5px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.2);
  }

  /* 2. Sticky First Column (Name) - FREEZE FIX */
  tbody td:first-child, thead th:first-child {
    position: sticky; 
    left: 0; 
    z-index: 21; /* Higher than normal cells */
    background-color: var(--card); /* Must hide scrolling content behind it */
    border-right: 1px solid #333; /* Visual separator */
  }
  /* Header corner needs highest Z-index */
  thead th:first-child { z-index: 25; background-color: #181818; }
  /* Hover effect handling for sticky col */
  tbody tr:hover td:first-child { background-color: #151515; }

  tbody td {
    padding: 10px 15px; border-bottom: 1px solid #1a1a1a;
    font-size: 0.9rem; color: #ccc; vertical-align: middle;
  }
  tbody tr:hover td { background: #151515; color: #fff; }

  /* --- Edit Mode Styles --- */
  tr.editing td { background: rgba(255, 215, 0, 0.05) !important; border-bottom: 1px solid var(--accent); }
  
  /* Inputs inside table */
  .t-input, .t-select {
    width: 100%; background: #000; border: 1px solid var(--accent); color: #fff;
    padding: 6px; border-radius: 4px; font-size: 0.85rem; outline: none;
  }
  .t-input:focus { box-shadow: 0 0 8px var(--accent-glow); }

  /* Action Buttons */
  .actions { display: flex; gap: 8px; }
  .btn-action {
    padding: 5px 12px; border-radius: 4px; font-size: 0.8rem; font-weight: 600; text-decoration: none; cursor: pointer; border: none;
  }
  .btn-edit { background: #222; color: var(--accent); border: 1px solid #333; }
  .btn-edit:hover { border-color: var(--accent); }
  .btn-save { background: var(--success); color: #000; }
  .btn-cancel { background: #333; color: #fff; }

  /* --- Footer/Pagination --- */
  .pager {
    padding: 12px 25px; background: #0c0c0c; border-top: 1px solid var(--card-border);
    display: flex; justify-content: space-between; align-items: center;
  }
  .page-info { font-size: 0.85rem; color: var(--muted); }
  .page-btn {
    padding: 6px 14px; background: #222; color: #fff; border: 1px solid #333;
    border-radius: 6px; cursor: pointer; transition: 0.2s;
  }
  .page-btn:hover:not([disabled]) { border-color: var(--accent); color: var(--accent); }
  .page-btn[disabled] { opacity: 0.4; cursor: not-allowed; }

  /* Animation */
  @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

  /* Flash Msg */
  .flash {
    position: absolute; top: 80px; left: 50%; transform: translateX(-50%); z-index: 100;
    padding: 10px 20px; border-radius: 8px; font-weight: 600; box-shadow: 0 5px 20px rgba(0,0,0,0.5);
  }
  .flash-success { background: var(--success); color: #000; }
  .flash-error { background: var(--danger); color: #fff; }
</style>

<div class="wrap">
  <div class="card">
    <!-- 1. Header -->
    <div class="head">
      <div>
        <h2>Team Timesheet Logs</h2>
        <div class="sub">
           Manage Logs 
           {% if selected_team %}| Team: <span style="color:var(--accent)">{{ selected_team }}</span>{% endif %}
        </div>
      </div>
    </div>

    <!-- Flash Messages -->
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        {% for cat, msg in messages %}
          <div class="flash flash-{{ 'success' if cat=='success' else 'error' }}">{{ msg }}</div>
        {% endfor %}
      {% endif %}
    {% endwith %}

    <!-- 2. Filters Toolbar -->
    <div class="toolbar">
      <form method="POST" id="filterForm">
        <input type="hidden" name="page" id="pageInput" value="{{ page|default(1) }}">
        
        <div class="filter-grid">
          
          <!-- TEAM Filter (Only for Superadmin) -->
          {% if role == 'superadmin' %}
          <div class="fg">
             <label>Team</label>
             <select name="team" class="f-control" onchange="this.form.submit()">
               <option value="">All Teams</option>
               {% for t in teams %}
                 <option value="{{ t }}" {% if selected_team == t %}selected{% endif %}>{{ t }}</option>
               {% endfor %}
             </select>
          </div>
          {% endif %}

          <!-- Name Filter (Populated dynamically from Backend based on team) -->
          <div class="fg">
            <label>Name</label>
            <select name="username" class="f-control" onchange="this.form.submit()">
              <option value="">All Users</option>
              {% for u in users %}
                <option value="{{ u.username }}" {% if request.form.username == u.username %}selected{% endif %}>{{ u.username }}</option>
              {% endfor %}
            </select>
          </div>

          <!-- Date Filter -->
          <div class="fg">
            <label>Date</label>
            <input type="date" name="date" class="f-control" value="{{ request.form.date or '' }}" onchange="this.form.submit()">
          </div>

          <!-- Project Filter -->
          <div class="fg">
            <label>Project</label>
            <select name="project" class="f-control" onchange="this.form.submit()">
              <option value="">All Projects</option>
              {% for p in projects %}
                <option value="{{ p }}" {% if request.form.project == p %}selected{% endif %}>{{ p }}</option>
              {% endfor %}
            </select>
          </div>

          <!-- Process Filter -->
          <div class="fg">
            <label>Process</label>
            <select name="process" class="f-control" onchange="this.form.submit()">
              <option value="">All Processes</option>
              {% for pr in processes %}
                <option value="{{ pr }}" {% if request.form.process == pr %}selected{% endif %}>{{ pr }}</option>
              {% endfor %}
            </select>
          </div>
          
           <!-- Sub Process Filter -->
           <div class="fg">
            <label>Sub-Process</label>
            <select name="sub_process" class="f-control" onchange="this.form.submit()">
              <option value="">All Sub-Proc</option>
              {% for sp in sub_processes %}
                <option value="{{ sp }}" {% if request.form.sub_process == sp %}selected{% endif %}>{{ sp }}</option>
              {% endfor %}
            </select>
          </div>

          <!-- Buttons -->
          <div class="fg" style="display: flex; gap: 8px;">
            <!-- Hidden submit for JS triggers, visible one for manual click -->
            <button class="f-control btn-filter" type="submit">Filter</button>
            <a href="{{ url_for('view_team_logs') }}" class="f-control btn-reset" style="text-decoration:none;">Reset</a>
          </div>
        </div>
      </form>
    </div>

    <!-- 3. Data Table -->
    <div class="table-wrap">
      
      <!-- EDIT FORM (Hidden) -->
      {% if editing_id %}
        <form id="editRowForm" method="POST" action="{{ url_for('update_entry') }}">
          <input type="hidden" name="entry_id" value="{{ editing_id }}">
          <!-- Next URL will be populated by JS to include current filters -->
          <input type="hidden" name="next" value=""> 
        </form>
      {% endif %}

      <table>
        <thead>
          <tr>
            <th>Name</th>
            <th>Date</th>
            <th>Project</th>
            <th>Process</th>
            <th>Sub-Process</th>
            <th style="width: 80px;">Start</th>
            <th style="width: 80px;">End</th>
            <th>Duration</th>
            <th>Total</th>
            <th style="text-align:center;">Action</th>
          </tr>
        </thead>
        <tbody>
          {% for row in logs %}
            {% set row_id = row[11] %}
            {% set is_edit = (editing_id == row_id|string) %}

            {% if is_edit %}
              <!-- EDIT MODE ROW -->
              <tr class="editing">
                <td>{{ row[0] }}</td> <!-- Name (Frozen) -->
                <td>{{ row[1] }}</td> <!-- Date -->
                
                <td>
                  <select name="project" form="editRowForm" class="t-select" required>
                    <option value="{{ row[3] }}" selected>{{ row[3] }}</option>
                    {% for p in projects %}
                        {% if p != row[3] %}<option value="{{ p }}">{{ p }}</option>{% endif %}
                    {% endfor %}
                  </select>
                </td>
                
                <td>
                  <select name="process" form="editRowForm" class="t-select" required>
                    <option value="{{ row[5] }}" selected>{{ row[5] }}</option>
                    {% for pr in processes %}
                        {% if pr != row[5] %}<option value="{{ pr }}">{{ pr }}</option>{% endif %}
                    {% endfor %}
                  </select>
                </td>

                <td>
                  <select name="sub_process" form="editRowForm" class="t-select" required>
                    <option value="{{ row[6] }}" selected>{{ row[6] }}</option>
                    {% for sp in sub_processes %}
                        {% if sp != row[6] %}<option value="{{ sp }}">{{ sp }}</option>{% endif %}
                    {% endfor %}
                  </select>
                </td>

                <td><input type="time" name="start_time" form="editRowForm" value="{{ row[7] }}" class="t-input" required></td>
                <td><input type="time" name="end_time" form="editRowForm" value="{{ row[8] }}" class="t-input" required></td>
                <td>{{ row[9] }}</td>
                <td>{{ row[10] }}</td>
                
                <td style="text-align: center;">
                  <div class="actions" style="justify-content: center;">
                    <button type="submit" form="editRowForm" class="btn-action btn-save">Save</button>
                    <!-- Cancel Button: Reloads page but removes editing_id, keeping filters -->
                    <button type="button" class="btn-action btn-cancel" onclick="cancelEdit()">Cancel</button>
                  </div>
                </td>
              </tr>
            {% else %}
              <!-- VIEW MODE ROW -->
              <tr>
                <td style="color: #fff; font-weight: 500;">{{ row[0] }}</td> <!-- Freeze Col -->
                <td>{{ row[1] }}</td>
                <td><span style="color:var(--accent);">{{ row[3] }}</span></td>
                <td>{{ row[5] }}</td>
                <td>{{ row[6] }}</td>
                <td>{{ row[7] }}</td>
                <td>{{ row[8] }}</td>
                <td>{{ row[9] }}</td>
                <td>{{ row[10] }}</td>
                <td style="text-align: center;">
                  <!-- Use JS to append current filters to edit URL -->
                  <a href="#" onclick="triggerEdit('{{ row_id }}')" class="btn-action btn-edit">Edit</a>
                  
                  {% if role == 'superadmin' %}
                  <form action="{{ url_for('delete_log', log_id=row_id) }}" method="POST" style="display:inline;" onsubmit="return confirm('Are you sure?')">
                     <button type="submit" style="background:none; border:none; color:var(--danger); cursor:pointer; font-size:1.1rem; vertical-align:middle;">&times;</button>
                  </form>
                  {% endif %}
                </td>
              </tr>
            {% endif %}
          {% endfor %}
          
          {% if logs|length == 0 %}
            <tr><td colspan="10" style="text-align:center; padding: 30px; color: var(--muted);">No logs found for these filters.</td></tr>
          {% endif %}
        </tbody>
      </table>
    </div>

    <!-- 4. Pagination -->
    {% set _page = page|default(1)|int %}
    {% set _tp = total_pages|default(1)|int %}
    <div class="pager">
      <div class="page-info">
        Page <strong>{{ _page }}</strong> of <strong>{{ _tp }}</strong> (Total: {{ total_rows }})
      </div>
      <div style="display:flex; gap:10px;">
        <button class="page-btn" id="prevBtn" {% if _page <= 1 %}disabled{% endif %}>Previous</button>
        <button class="page-btn" id="nextBtn" {% if _page >= _tp %}disabled{% endif %}>Next</button>
      </div>
    </div>
  </div>
</div>

<script>
  // 1. Pagination Logic
  const filterForm = document.getElementById('filterForm');
  const pageInput = document.getElementById('pageInput');
  const totalPages = {{ total_pages|default(1) }};

  document.getElementById('prevBtn')?.addEventListener('click', () => {
    let p = parseInt(pageInput.value) || 1;
    if(p > 1) { pageInput.value = p - 1; filterForm.submit(); }
  });

  document.getElementById('nextBtn')?.addEventListener('click', () => {
    let p = parseInt(pageInput.value) || 1;
    if(p < totalPages) { pageInput.value = p + 1; filterForm.submit(); }
  });

  // 2. Handling Edits while preserving filters
  // When clicking Edit, we take current URL params and add editing_id
  function triggerEdit(id) {
    const url = new URL(window.location.href);
    url.searchParams.set('editing_id', id);
    window.location.href = url.toString();
  }

  // When clicking Cancel, remove editing_id but keep filters
  function cancelEdit() {
    const url = new URL(window.location.href);
    url.searchParams.delete('editing_id');
    window.location.href = url.toString();
  }

  // Fix: Set 'next' URL for the edit form so it returns to same filtered view
  const editForm = document.getElementById('editRowForm');
  if(editForm){
     const url = new URL(window.location.href);
     url.searchParams.delete('editing_id'); // Remove edit ID from the return URL
     editForm.querySelector('input[name="next"]').value = url.pathname + '?' + url.searchParams.toString();
  }

  // 3. Auto-hide flash messages
  setTimeout(() => {
    const flashes = document.querySelectorAll('.flash');
    flashes.forEach(f => {
      f.style.transition = "opacity 0.5s ease";
      f.style.opacity = 0;
      setTimeout(() => f.remove(), 500);
    });
  }, 4000);
</script>
{% endblock %}