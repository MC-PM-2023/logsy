<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard | Enterprise Analytics</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        .card-hover:hover { transform: translateY(-2px); transition: all 0.3s ease; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); }
        .glass-header { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); }
        /* Smooth Scrollbar for Table */
        .custom-scrollbar::-webkit-scrollbar { width: 6px; height: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f5f9; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        /* Modal Animation */
        .modal-enter { opacity: 0; transform: scale(0.95); }
        .modal-enter-active { opacity: 1; transform: scale(1); transition: all 0.2s ease-out; }
        .modal-exit { opacity: 1; transform: scale(1); }
        .modal-exit-active { opacity: 0; transform: scale(0.95); transition: all 0.2s ease-in; }
    </style>
</head>
<body class="text-slate-800 relative">

    <!-- Top Navigation -->
    <nav class="glass-header fixed w-full z-20 border-b border-gray-200 h-16 flex items-center justify-between px-6 lg:px-10 shadow-sm">
        <div class="flex items-center gap-3">
            <div class="bg-indigo-600 text-white p-2 rounded-lg shadow-indigo-200 shadow-lg">
                <i class="fas fa-chart-line text-lg"></i>
            </div>
            <span class="text-xl font-bold tracking-tight text-slate-800">Timesheet<span class="text-indigo-600">Admin</span></span>
        </div>
        
        <div class="flex items-center gap-4">
            <div class="hidden md:flex flex-col items-end mr-2">
                <span class="text-sm font-semibold text-slate-700">{{ current_user.username }}</span>
                <span class="text-xs text-slate-500 capitalize bg-indigo-50 px-2 py-0.5 rounded-full text-indigo-700 font-medium">{{ current_user.role }}</span>
            </div>
            <div class="h-10 w-10 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-full flex items-center justify-center text-white font-bold border-2 border-white shadow-md uppercase text-sm">
                {{ current_user.username[:2] }}
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="pt-24 px-4 lg:px-8 pb-10 max-w-[1920px] mx-auto">
        
        <!-- Header & Filters -->
        <div class="flex flex-col xl:flex-row justify-between items-start xl:items-end gap-6 mb-8">
            <div>
                <h1 class="text-2xl font-bold text-slate-800">Dashboard Overview</h1>
                <p class="text-slate-500 text-sm mt-1">
                    Team: <span class="font-semibold text-indigo-600 bg-indigo-50 px-2 py-1 rounded">{{ current_user.team }}</span>
                </p>
            </div>
            
            <!-- Filter Form -->
            <form method="POST" action="/admin/admin/dashboard" class="bg-white p-4 rounded-xl shadow-sm border border-gray-200 flex flex-wrap gap-4 items-end w-full xl:w-auto">
                <div class="flex-grow min-w-[200px]">
                    <label class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-1.5">User</label>
                    <div class="relative">
                        <i class="fas fa-user absolute left-3 top-3 text-gray-400"></i>
                        <select name="user_select" class="w-full pl-9 bg-gray-50 border border-gray-200 text-sm rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 block p-2.5 outline-none transition-all">
                            <option value="all">All Users</option>
                            {% for user in users %}
                                <option value="{{ user }}" {% if selected_user == user %}selected{% endif %}>{{ user }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-1.5">Start Date</label>
                    <input type="date" name="start_date" value="{{ start_date if start_date else '' }}" class="bg-gray-50 border border-gray-200 text-slate-900 text-sm rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 block w-full p-2.5 outline-none transition-all">
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-1.5">End Date</label>
                    <input type="date" name="end_date" value="{{ end_date if end_date else '' }}" class="bg-gray-50 border border-gray-200 text-slate-900 text-sm rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 block w-full p-2.5 outline-none transition-all">
                </div>
                <button type="submit" class="bg-indigo-600 hover:bg-indigo-700 text-white font-medium rounded-lg text-sm px-6 py-2.5 transition-all shadow-md shadow-indigo-200 flex items-center gap-2 h-[42px]">
                    <i class="fas fa-filter"></i> Apply
                </button>
            </form>
        </div>

        <!-- KPI Grid -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-5 gap-6 mb-8">
            <!-- KPI 1 -->
            <div class="bg-white rounded-2xl p-6 border border-gray-100 shadow-sm card-hover relative overflow-hidden group">
                <div class="absolute right-0 top-0 h-full w-1 bg-indigo-500"></div>
                <div class="flex justify-between items-start">
                    <div>
                        <p class="text-xs font-bold text-slate-400 uppercase tracking-wider">Total Work</p>
                        <h3 class="text-3xl font-bold text-slate-800 mt-2 format-time">{{ total_work_hours }}</h3>
                    </div>
                    <div class="p-3 bg-indigo-50 rounded-xl text-indigo-600 group-hover:bg-indigo-600 group-hover:text-white transition-colors">
                        <i class="fas fa-briefcase text-xl"></i>
                    </div>
                </div>
            </div>
            <!-- KPI 2 -->
            <div class="bg-white rounded-2xl p-6 border border-gray-100 shadow-sm card-hover relative overflow-hidden group">
                <div class="absolute right-0 top-0 h-full w-1 bg-amber-400"></div>
                <div class="flex justify-between items-start">
                    <div>
                        <p class="text-xs font-bold text-slate-400 uppercase tracking-wider">Total Break</p>
                        <h3 class="text-3xl font-bold text-slate-800 mt-2 format-time">{{ total_break_hours }}</h3>
                    </div>
                    <div class="p-3 bg-amber-50 rounded-xl text-amber-500 group-hover:bg-amber-500 group-hover:text-white transition-colors">
                        <i class="fas fa-pause text-xl"></i>
                    </div>
                </div>
            </div>
            <!-- KPI 3 -->
            <div class="bg-white rounded-2xl p-6 border border-gray-100 shadow-sm card-hover relative overflow-hidden group">
                <div class="absolute right-0 top-0 h-full w-1 bg-cyan-500"></div>
                <div class="flex justify-between items-start">
                    <div>
                        <p class="text-xs font-bold text-slate-400 uppercase tracking-wider">Avg Hrs / User</p>
                        <h3 class="text-3xl font-bold text-slate-800 mt-2 format-time">{{ avg_hours_per_user }}</h3>
                    </div>
                    <div class="p-3 bg-cyan-50 rounded-xl text-cyan-500 group-hover:bg-cyan-500 group-hover:text-white transition-colors">
                        <i class="fas fa-tachometer-alt text-xl"></i>
                    </div>
                </div>
            </div>
            <!-- KPI 4 -->
            <div class="bg-white rounded-2xl p-6 border border-gray-100 shadow-sm card-hover relative overflow-hidden group">
                <div class="absolute right-0 top-0 h-full w-1 bg-emerald-500"></div>
                <div class="flex justify-between items-start">
                    <div>
                        <p class="text-xs font-bold text-slate-400 uppercase tracking-wider">Log Entries</p>
                        <h3 class="text-3xl font-bold text-slate-800 mt-2">{{ total_entries }}</h3>
                    </div>
                    <div class="p-3 bg-emerald-50 rounded-xl text-emerald-500 group-hover:bg-emerald-500 group-hover:text-white transition-colors">
                        <i class="fas fa-list text-xl"></i>
                    </div>
                </div>
            </div>
            <!-- KPI 5: Active Users (CLICKABLE NOW) -->
            <div onclick="openUserHub()" class="bg-white rounded-2xl p-6 border border-gray-100 shadow-sm card-hover relative overflow-hidden group cursor-pointer hover:bg-purple-50 transition-colors">
                <div class="absolute right-0 top-0 h-full w-1 bg-purple-500"></div>
                <div class="flex justify-between items-start">
                    <div>
                        <p class="text-xs font-bold text-slate-400 uppercase tracking-wider group-hover:text-purple-600">Active Users</p>
                        <h3 class="text-3xl font-bold text-slate-800 mt-2">{{ total_users }}</h3>
                        <p class="text-xs text-purple-600 mt-2 font-semibold">
                            <i class="fas fa-external-link-alt mr-1"></i> View Directory
                        </p>
                    </div>
                    <div class="p-3 bg-purple-50 rounded-xl text-purple-500 group-hover:bg-purple-600 group-hover:text-white transition-colors">
                        <i class="fas fa-users text-xl"></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- Charts Row 1 -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
            <!-- Main Trend Chart -->
            <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6 lg:col-span-2">
                <div class="flex justify-between items-center mb-6">
                    <div>
                        <h3 class="font-bold text-slate-800 text-lg">Work vs Break Trend</h3>
                        <p class="text-xs text-slate-400">Click bars to see details</p>
                    </div>
                    <span class="bg-gray-100 text-gray-500 text-xs font-medium px-2.5 py-1 rounded-lg border border-gray-200">Last 7 Days</span>
                </div>
                <div class="relative h-80 w-full">
                    <canvas id="trendChart"></canvas>
                </div>
            </div>

            <!-- Process Distribution -->
            <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6">
                <h3 class="font-bold text-slate-800 text-lg mb-2">Process Distribution</h3>
                <p class="text-xs text-slate-400 mb-6">Click slices to filter logs</p>
                <div class="relative h-72 w-full flex justify-center">
                    <canvas id="processChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Charts Row 2 -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
            <!-- Top Projects -->
            <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6">
                <h3 class="font-bold text-slate-800 text-lg mb-4">Top Projects <span class="text-sm font-normal text-slate-400">(Click to view logs)</span></h3>
                <div class="relative h-80 w-full">
                    <canvas id="projectChart"></canvas>
                </div>
            </div>

            <!-- Top Users -->
            <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6">
                <h3 class="font-bold text-slate-800 text-lg mb-4">Top Contributors <span class="text-sm font-normal text-slate-400">(Click to view logs)</span></h3>
                <div class="relative h-80 w-full">
                    <canvas id="userChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Data Table -->
        <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden mb-12">
            <div class="p-6 border-b border-gray-100 flex flex-col md:flex-row justify-between items-center gap-4">
                <div>
                    <h3 class="font-bold text-slate-800 text-lg">Recent Log Entries</h3>
                </div>
                <button class="bg-white border border-gray-300 hover:bg-gray-50 text-slate-700 text-sm font-medium py-2 px-4 rounded-lg shadow-sm transition-all flex items-center">
                    <i class="fas fa-download mr-2 text-slate-400"></i> Export CSV
                </button>
            </div>
            <div class="overflow-x-auto custom-scrollbar">
                <table class="w-full text-sm text-left text-gray-500">
                    <thead class="text-xs text-gray-700 uppercase bg-gray-50/50 sticky top-0">
                        <tr>
                            <th class="px-6 py-4 font-bold text-slate-600">Name</th>
                            <th class="px-6 py-4 font-bold text-slate-600">Date</th>
                            <th class="px-6 py-4 font-bold text-slate-600">Project</th>
                            <th class="px-6 py-4 font-bold text-slate-600">Process</th>
                            <th class="px-6 py-4 font-bold text-slate-600">Duration</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-100" id="tableBody">
                        {% for row in table_data %}
                        <tr class="bg-white hover:bg-gray-50 transition-colors">
                            <td class="px-6 py-4 font-medium text-gray-900">{{ row[0] }}</td>
                            <td class="px-6 py-4 text-slate-500">{{ row[1] }}</td>
                            <td class="px-6 py-4"><span class="bg-slate-100 px-2 py-1 rounded text-xs">{{ row[2] }}</span></td>
                            <td class="px-6 py-4">{{ row[3] }}</td>
                            <td class="px-6 py-4 font-mono text-indigo-600 font-bold"><span class="format-time">{{ row[5] }}</span></td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

    </main>

    <!-- DRILL DOWN MODAL (Existing) -->
    <div id="detailsModal" class="fixed inset-0 z-50 hidden" aria-labelledby="modal-title" role="dialog" aria-modal="true">
        <div class="fixed inset-0 bg-gray-900/50 backdrop-blur-sm transition-opacity" onclick="closeModal()"></div>
        <div class="fixed inset-0 z-10 overflow-y-auto">
            <div class="flex min-h-full items-center justify-center p-4 text-center sm:p-0">
                <div class="relative transform overflow-hidden rounded-2xl bg-white text-left shadow-2xl transition-all sm:my-8 sm:w-full sm:max-w-4xl border border-gray-100">
                    <!-- Modal Header -->
                    <div class="bg-white px-4 pb-4 pt-5 sm:p-6 sm:pb-4 border-b border-gray-100 flex justify-between items-center">
                        <div class="flex items-center gap-3">
                            <div class="h-10 w-10 bg-indigo-50 rounded-full flex items-center justify-center text-indigo-600">
                                <i class="fas fa-list-alt text-lg"></i>
                            </div>
                            <div>
                                <h3 class="text-lg font-bold leading-6 text-gray-900" id="modalTitle">Drill Down Details</h3>
                                <p class="text-xs text-gray-500 mt-0.5">Viewing filtered records</p>
                            </div>
                        </div>
                        <button type="button" class="text-gray-400 hover:text-gray-600 transition-colors" onclick="closeModal()">
                            <i class="fas fa-times text-xl"></i>
                        </button>
                    </div>
                    <!-- Modal Body (Table) -->
                    <div class="bg-gray-50/50 px-4 py-4 sm:p-6 max-h-[60vh] overflow-y-auto custom-scrollbar">
                        <table class="w-full text-sm text-left text-gray-500 shadow-sm rounded-lg overflow-hidden border border-gray-200 bg-white">
                            <thead class="text-xs text-gray-700 uppercase bg-gray-50 sticky top-0">
                                <tr>
                                    <th class="px-6 py-3">Name</th>
                                    <th class="px-6 py-3">Date</th>
                                    <th class="px-6 py-3">Project</th>
                                    <th class="px-6 py-3">Process</th>
                                    <th class="px-6 py-3">Sub Process</th>
                                    <th class="px-6 py-3 text-right">Duration</th>
                                </tr>
                            </thead>
                            <tbody id="modalTableBody" class="divide-y divide-gray-100"></tbody>
                        </table>
                        <div id="noDataMessage" class="hidden text-center py-10 text-gray-400">
                            <i class="fas fa-inbox text-3xl mb-2"></i>
                            <p>No matching records found in recent logs.</p>
                        </div>
                    </div>
                    <!-- Modal Footer -->
                    <div class="bg-white px-4 py-3 sm:flex sm:flex-row-reverse sm:px-6 border-t border-gray-100">
                        <button type="button" class="mt-3 inline-flex w-full justify-center rounded-lg bg-white px-3 py-2 text-sm font-semibold text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50 sm:mt-0 sm:w-auto transition-all" onclick="closeModal()">Close</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- USER HUB MODAL (NEW SUPER FEATURE) -->
    <div id="userHubModal" class="fixed inset-0 z-50 hidden" aria-labelledby="modal-title" role="dialog" aria-modal="true">
        <div class="fixed inset-0 bg-gray-900/60 backdrop-blur-md transition-opacity" onclick="closeUserHub()"></div>
        <div class="fixed inset-0 z-10 overflow-y-auto">
            <div class="flex min-h-full items-center justify-center p-4 text-center sm:p-0">
                <div class="relative transform overflow-hidden rounded-2xl bg-white text-left shadow-2xl transition-all sm:my-8 sm:w-full sm:max-w-5xl border border-gray-100">
                    
                    <!-- Header -->
                    <div class="bg-white px-6 py-5 border-b border-gray-100 flex flex-col md:flex-row justify-between items-center gap-4">
                        <div class="flex items-center gap-4">
                            <div class="h-12 w-12 bg-purple-100 rounded-xl flex items-center justify-center text-purple-600 shadow-sm">
                                <i class="fas fa-users-cog text-2xl"></i>
                            </div>
                            <div>
                                <h3 class="text-xl font-bold leading-6 text-gray-900">Contributors Intelligence Hub</h3>
                                <p class="text-sm text-gray-500 mt-1">Advanced analytics per user</p>
                            </div>
                        </div>
                        <div class="flex gap-3 w-full md:w-auto">
                             <div class="relative flex-grow md:flex-grow-0">
                                <i class="fas fa-search absolute left-3 top-3 text-gray-400"></i>
                                <input type="text" id="userHubSearch" placeholder="Search user..." class="pl-10 pr-4 py-2 border border-gray-200 rounded-lg text-sm focus:ring-2 focus:ring-purple-500 outline-none w-full" onkeyup="filterUserHub()">
                            </div>
                            <button type="button" class="text-gray-400 hover:text-gray-600 transition-colors p-2" onclick="closeUserHub()">
                                <i class="fas fa-times text-xl"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Hub Body -->
                    <div class="bg-gray-50 px-6 py-6 max-h-[70vh] overflow-y-auto custom-scrollbar">
                        <div id="userCardsGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-5">
                            <!-- Cards Injected via JS -->
                        </div>
                    </div>

                    <!-- Footer -->
                    <div class="bg-white px-6 py-4 border-t border-gray-100 flex justify-between items-center">
                        <span class="text-xs text-gray-400" id="userHubCount">Loading users...</span>
                        <button type="button" class="rounded-lg bg-gray-100 px-4 py-2 text-sm font-semibold text-gray-700 hover:bg-gray-200 transition-all" onclick="closeUserHub()">Close Directory</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ==========================================
        //  1. HELPERS & FORMATTERS
        // ==========================================
        function decimalToHHMM(decimal) {
            if (!decimal && decimal !== 0) return "00:00";
            if (decimal > 1000) decimal = decimal / 3600;
            const hrs = Math.floor(decimal);
            const mins = Math.round((decimal - hrs) * 60);
            if (mins === 60) return `${hrs + 1}:00`;
            return `${hrs}:${mins.toString().padStart(2, '0')}`;
        }

        // Apply formatting on load
        document.addEventListener('DOMContentLoaded', () => {
            document.querySelectorAll('.format-time').forEach(el => {
                const text = el.innerText.trim();
                if (text.includes(':')) {
                    const parts = text.split(':');
                    if (parts.length >= 2) { el.innerText = `${parseInt(parts[0])}:${parts[1]}`; return; }
                }
                const val = parseFloat(text);
                if (!isNaN(val)) el.innerText = decimalToHHMM(val);
            });
        });

        // ==========================================
        //  2. DRILL-DOWN LOGIC (INTERACTIVITY)
        // ==========================================
        const allLogs = {{ table_data | tojson }};

        const modal = document.getElementById('detailsModal');
        const modalTitle = document.getElementById('modalTitle');
        const modalTableBody = document.getElementById('modalTableBody');
        const noDataMessage = document.getElementById('noDataMessage');

        function openModal(title, filterFn) {
            modalTitle.innerText = title;
            modalTableBody.innerHTML = ''; 
            const filteredLogs = allLogs.filter(filterFn);

            if (filteredLogs.length === 0) {
                noDataMessage.classList.remove('hidden');
            } else {
                noDataMessage.classList.add('hidden');
                filteredLogs.forEach(row => {
                    const tr = document.createElement('tr');
                    tr.className = "hover:bg-gray-50 transition-colors";
                    let processColor = row[3] === 'Breaks' ? 'text-amber-600' : 'text-emerald-600';
                    let processIcon = row[3] === 'Breaks' ? '<i class="fas fa-mug-hot text-xs mr-1"></i>' : '<i class="fas fa-check-circle text-xs mr-1"></i>';

                    tr.innerHTML = `
                        <td class="px-6 py-3 font-medium text-gray-900">${row[0]}</td>
                        <td class="px-6 py-3 text-slate-500">${row[1]}</td>
                        <td class="px-6 py-3"><span class="bg-slate-100 border border-slate-200 px-2 py-0.5 rounded text-xs text-slate-600 font-semibold">${row[2]}</span></td>
                        <td class="px-6 py-3 font-semibold ${processColor}">${processIcon} ${row[3]}</td>
                        <td class="px-6 py-3 text-slate-500">${row[4] || '-'}</td>
                        <td class="px-6 py-3 text-right font-mono text-indigo-600 font-bold">${decimalToHHMM(row[5])}</td>
                    `;
                    modalTableBody.appendChild(tr);
                });
            }
            modal.classList.remove('hidden');
        }

        function closeModal() {
            modal.classList.add('hidden');
        }

        // ==========================================
        //  3. USER INTELLIGENCE HUB (NEW)
        // ==========================================
        const userHubModal = document.getElementById('userHubModal');
        const userCardsGrid = document.getElementById('userCardsGrid');
        let userStats = [];

        function generateUserStats() {
            const stats = {};
            // Aggregate data from allLogs
            allLogs.forEach(row => {
                const name = row[0];
                const project = row[2];
                // Handle different duration formats if necessary, here assumed float
                const duration = typeof row[5] === 'string' && row[5].includes(':') 
                    ? parseFloat(row[5].split(':')[0]) + parseFloat(row[5].split(':')[1])/60 
                    : parseFloat(row[5]);

                if (!stats[name]) {
                    stats[name] = { 
                        name: name, 
                        totalHours: 0, 
                        projects: {}, 
                        entries: 0,
                        lastActive: row[1]
                    };
                }
                stats[name].totalHours += (isNaN(duration) ? 0 : duration);
                stats[name].entries += 1;
                stats[name].projects[project] = (stats[name].projects[project] || 0) + 1;
                // Simple date compare for last active
                if (row[1] > stats[name].lastActive) stats[name].lastActive = row[1];
            });

            // Convert to array and find top project
            return Object.values(stats).map(u => {
                // Find Top Project
                let topProj = 'N/A';
                let maxCount = 0;
                for (const [proj, count] of Object.entries(u.projects)) {
                    if (count > maxCount) { maxCount = count; topProj = proj; }
                }
                u.topProject = topProj;
                return u;
            }).sort((a, b) => b.totalHours - a.totalHours); // Sort by hours desc
        }

        function openUserHub() {
            userStats = generateUserStats();
            renderUserCards(userStats);
            userHubModal.classList.remove('hidden');
        }

        function closeUserHub() {
            userHubModal.classList.add('hidden');
        }

        function renderUserCards(data) {
            userCardsGrid.innerHTML = '';
            document.getElementById('userHubCount').innerText = `${data.length} Active Contributors`;

            if (data.length === 0) {
                userCardsGrid.innerHTML = `<div class="col-span-full text-center text-gray-400 py-10">No users found.</div>`;
                return;
            }

            // Find Max hours for Progress Bar
            const maxHours = Math.max(...data.map(u => u.totalHours)) || 1;

            data.forEach(user => {
                const percentage = Math.round((user.totalHours / maxHours) * 100);
                const initials = user.name.slice(0, 2).toUpperCase();
                
                // Card HTML
                const card = document.createElement('div');
                card.className = "bg-white rounded-xl p-5 border border-gray-200 shadow-sm hover:shadow-md transition-shadow relative overflow-hidden";
                card.innerHTML = `
                    <div class="flex items-center gap-4 mb-4">
                        <div class="h-12 w-12 rounded-full bg-gradient-to-br from-purple-500 to-indigo-600 text-white flex items-center justify-center font-bold text-lg shadow-md border-2 border-white">
                            ${initials}
                        </div>
                        <div>
                            <h4 class="font-bold text-gray-800 text-lg leading-tight">${user.name}</h4>
                            <p class="text-xs text-gray-500 mt-0.5"><i class="fas fa-clock mr-1"></i>Last Active: ${user.lastActive}</p>
                        </div>
                    </div>
                    
                    <div class="space-y-3">
                        <div class="flex justify-between items-center text-sm">
                            <span class="text-gray-500">Focus Area</span>
                            <span class="font-semibold text-indigo-600 bg-indigo-50 px-2 py-0.5 rounded text-xs truncate max-w-[120px]">${user.topProject}</span>
                        </div>
                        <div class="flex justify-between items-center text-sm">
                            <span class="text-gray-500">Total Output</span>
                            <span class="font-bold text-gray-800">${decimalToHHMM(user.totalHours)} <span class="text-xs font-normal text-gray-400">/ ${user.entries} logs</span></span>
                        </div>
                        
                        <!-- Efficiency Bar -->
                        <div class="w-full bg-gray-100 rounded-full h-1.5 mt-2">
                            <div class="bg-purple-500 h-1.5 rounded-full" style="width: ${percentage}%"></div>
                        </div>
                    </div>

                    <button onclick="closeUserHub(); openModal('Logs for ${user.name}', (row) => row[0] == '${user.name}')" class="w-full mt-5 bg-white border border-gray-200 hover:bg-gray-50 text-gray-700 font-medium py-2 rounded-lg text-sm transition-colors shadow-sm">
                        View Activity Log
                    </button>
                `;
                userCardsGrid.appendChild(card);
            });
        }

        function filterUserHub() {
            const query = document.getElementById('userHubSearch').value.toLowerCase();
            const filtered = userStats.filter(u => 
                u.name.toLowerCase().includes(query) || 
                u.topProject.toLowerCase().includes(query)
            );
            renderUserCards(filtered);
        }

        // ==========================================
        //  4. CHART CONFIGURATIONS
        // ==========================================
        
        const rawTrendData = {{ daily_work_break_data | tojson }};
        rawTrendData.reverse(); 
        const dailyLabels = rawTrendData.map(d => d[0]);
        const dailyWork = rawTrendData.map(d => d[1]);
        const dailyBreak = rawTrendData.map(d => d[2]);

        const rawProcessData = {{ process_data | tojson }};
        const processLabels = rawProcessData.map(d => d[0]);
        const processData = rawProcessData.map(d => d[1]);

        const rawProjectData = {{ project_hours_data | tojson }};
        const projectLabels = rawProjectData.map(d => d[0]);
        const projectData = rawProjectData.map(d => d[1]);

        const rawUserData = {{ user_hours | tojson }};
        const userLabels = rawUserData.map(d => d[0]);
        const userData = rawUserData.map(d => d[1]);

        Chart.defaults.font.family = "'Inter', sans-serif";
        Chart.defaults.color = '#64748b';
        
        const commonTooltipOptions = {
            backgroundColor: 'rgba(15, 23, 42, 0.9)',
            titleColor: '#f8fafc',
            bodyColor: '#e2e8f0',
            padding: 12,
            cornerRadius: 8,
            displayColors: true,
            callbacks: {
                label: function(context) {
                    let label = context.dataset.label || context.label || '';
                    if (label) label += ': ';
                    if (context.parsed.y !== null && context.chart.config.type !== 'doughnut' && (context.chart.config.type !== 'bar' || context.chart.config.options.indexAxis !== 'y')) {
                         label += decimalToHHMM(context.parsed.y);
                    } else if (context.parsed.x !== null && context.chart.config.type !== 'doughnut') { 
                         label += decimalToHHMM(context.parsed.x);
                    } else if (context.raw !== null) {
                        label += decimalToHHMM(context.raw);
                    }
                    return label;
                }
            }
        };

        // --- 1. Trend Chart (Clickable) ---
        new Chart(document.getElementById('trendChart'), {
            type: 'bar',
            data: {
                labels: dailyLabels,
                datasets: [
                    { label: 'Work', data: dailyWork, backgroundColor: '#6366f1', borderRadius: 6 },
                    { label: 'Break', data: dailyBreak, backgroundColor: '#fbbf24', borderRadius: 6 }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: { x: { stacked: true, grid: { display: false } }, y: { stacked: true, grid: { borderDash: [4, 4] }, ticks: { callback: v => decimalToHHMM(v) } } },
                plugins: { legend: { position: 'top', align: 'end' }, tooltip: commonTooltipOptions },
                onClick: (e, activeEls, chart) => {
                    if (activeEls.length > 0) {
                        const index = activeEls[0].index;
                        const dateClicked = chart.data.labels[index];
                        openModal(`Logs for ${dateClicked}`, (row) => row[1] == dateClicked);
                    }
                }
            }
        });

        // --- 2. Process Chart (Clickable) ---
        new Chart(document.getElementById('processChart'), {
            type: 'doughnut',
            data: {
                labels: processLabels,
                datasets: [{
                    data: processData,
                    backgroundColor: ['#6366f1', '#10b981', '#3b82f6', '#f59e0b', '#8b5cf6', '#ec4899'],
                    borderWidth: 0,
                    hoverOffset: 10
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                cutout: '75%',
                plugins: { legend: { position: 'right' }, tooltip: commonTooltipOptions },
                onClick: (e, activeEls, chart) => {
                    if (activeEls.length > 0) {
                        const index = activeEls[0].index;
                        const processClicked = chart.data.labels[index];
                        openModal(`Logs: ${processClicked}`, (row) => row[3] == processClicked);
                    }
                }
            }
        });

        // --- 3. Project Chart (Clickable) ---
        new Chart(document.getElementById('projectChart'), {
            type: 'bar',
            indexAxis: 'y',
            data: {
                labels: projectLabels,
                datasets: [{ label: 'Hours', data: projectData, backgroundColor: '#3b82f6', borderRadius: 4 }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false }, tooltip: commonTooltipOptions },
                scales: { x: { grid: { borderDash: [4, 4] }, ticks: { callback: v => decimalToHHMM(v) } }, y: { grid: { display: false } } },
                onClick: (e, activeEls, chart) => {
                    if (activeEls.length > 0) {
                        const index = activeEls[0].index;
                        const projectClicked = chart.data.labels[index];
                        openModal(`Logs for ${projectClicked}`, (row) => row[2] == projectClicked);
                    }
                }
            }
        });

        // --- 4. User Chart (Clickable) ---
        new Chart(document.getElementById('userChart'), {
            type: 'bar',
            data: {
                labels: userLabels,
                datasets: [{ label: 'Hours', data: userData, backgroundColor: '#10b981', borderRadius: 6 }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false }, tooltip: commonTooltipOptions },
                scales: { y: { grid: { borderDash: [4, 4] }, ticks: { callback: v => decimalToHHMM(v) } }, x: { grid: { display: false } } },
                onClick: (e, activeEls, chart) => {
                    if (activeEls.length > 0) {
                        const index = activeEls[0].index;
                        const userClicked = chart.data.labels[index];
                        openModal(`Logs for ${userClicked}`, (row) => row[0] == userClicked);
                    }
                }
            }
        });
    </script>
</body>
</html>