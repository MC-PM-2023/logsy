{% extends "base.html" %}
{% block title %}Logsy - Allocations{% endblock %}

{% block content %}
<style>
/* --- Theme Variables --- */
:root{
  --primary:#ffd24d; --primary-hover:#e6bc46;
  --accent:#2ecc71;  --warning:#ffb037;
  --danger:#e74c3c;
  --bg:#0f151d;      --card-bg:#30363d;
  --head-grad:linear-gradient(135deg,#ffd24d 0%,#ffdb6e 100%);
  --border:#1e242d;  --row-hover:#232b35;
  --scroll-thumb:#8a8e96; --scroll-track:#1b212a;
}

/* 1. RESET & FIXED LAYOUT */
html, body { height: 100%; margin: 0; padding: 0; overflow: hidden; }

body {
  font-family: 'Segoe UI', Tahoma, Arial, sans-serif;
  background: var(--bg);
  color: #e5e7eb;
  font-size: 12px; 
}

/* Wrapper */
.wrap {
  height: calc(100vh - 90px);
  
  /* FIXED: Changed from 100% to auto so margins don't push it off-screen */
  width: auto; 
  
  padding: 10px 15px; 
  display: flex;
  flex-direction: column;
  margin: 0;
  transition: margin-left 0.3s ease-in-out;
}

/* Card Container */
.card {
  background: var(--card-bg);
  border-radius: 8px;
  box-shadow: 0 14px 34px rgba(0,0,0,.25);
  display: flex;
  flex-direction: column;
  height: 100%; 
  overflow: hidden;
  padding: 0;
  width: 100%;
}

/* --- 2. Compact Top Section --- */
.top-section {
  padding: 10px 15px;
  border-bottom: 1px solid var(--border);
  background: #252a30;
  flex-shrink: 0;
  display: flex;
  flex-direction: column;
  gap: 10px;
}

.header-row {
  display: flex; justify-content: space-between; align-items: center;
}

.back {
  color: var(--primary); font-weight: 600; text-decoration: none;
  font-size: 12px; transition: color .15s;
}
.back:hover { color: var(--primary-hover); }

h1 { margin: 0; font-size: 16px; color: #b8e4ff; line-height: 1; }

/* Flash Messages */
.flash-container { margin-bottom: 0; }
.flash { padding: 4px 10px; border-radius: 4px; font-size: 11px; font-weight: 600; display: inline-block; }
.flash.success { background: #e9f8f1; color: var(--accent); }
.flash.error { background: #fff4eb; color: var(--danger); }

/* Compact Form Grid */
.form-grid {
  display: grid; 
  grid-template-columns: repeat(auto-fit, minmax(130px, 1fr));
  gap: 8px;
  align-items: end;
}

.fg { display: flex; flex-direction: column; gap: 3px; }
.fg label { font-size: 11px; color: #aaa; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; }

/* Compact Inputs */
input, select {
  font-size: 12px; padding: 4px 8px; border-radius: 4px;
  border: 1px solid var(--border);
  background: #1c222b; color: #e5e7eb;
  width: 100%; box-sizing: border-box;
  outline: none;
  height: 30px; 
  transition: border-color 0.2s;
}
input:focus, select:focus { border-color: var(--primary); box-shadow: 0 0 0 1px rgba(255, 210, 77, 0.1); }
input[readonly] { background: #15181c; color: #777; border-color: #333; cursor: not-allowed; }

button {
  padding: 0 12px; border: none; border-radius: 4px;
  font-weight: 600; cursor: pointer; white-space: nowrap;
  height: 30px; font-size: 12px;
}
.btn-yellow { background: var(--primary); color: #050505; }
.btn-yellow:hover { background: var(--primary-hover); }

.btn-ghost { background: #444; color: #fff; padding: 0 8px; height: 24px; font-size: 11px; }
.btn-ghost:hover { background: #555; }

/* --- 3. Table Area --- */
.table-wrap {
  flex: 1;           
  overflow: auto;    
  position: relative;
  width: 100%;
  padding: 0;
}

/* Scrollbar Styling */
.table-wrap::-webkit-scrollbar { width: 6px; height: 6px; }
.table-wrap::-webkit-scrollbar-track { background: var(--scroll-track); }
.table-wrap::-webkit-scrollbar-thumb { background: var(--scroll-thumb); border-radius: 4px; }

table { 
  width: 100%; border-collapse: separate; border-spacing: 0; font-size: 12px; 
  /* Fixed layout ensures columns obey the width we set */
  table-layout: fixed; 
  /* Min width reduced to ensure it tries to fit in screen first */
  min-width: 100%; 
}

/* --- DOUBLE STICKY HEADER MAGIC --- */
thead tr:first-child th {
  background: var(--head-grad); color: #111; font-weight: 700;
  position: sticky; top: 0; z-index: 20;
  padding: 6px 10px; text-align: left;
  border-bottom: 1px solid #000;
  height: 34px; box-sizing: border-box;
}

thead tr.filters-row th {
  background: #22272e; 
  position: sticky; top: 34px; 
  z-index: 19;
  padding: 4px 10px;
  border-bottom: 1px solid var(--border);
  height: 38px; box-sizing: border-box;
}

td {
  padding: 5px 10px; border-bottom: 1px solid var(--border);
  color: #ccc; vertical-align: middle;
  white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
}

tbody tr:nth-child(even) { background: #2a2f36; }
tbody tr:hover { background: var(--row-hover); }

/* Filter Selects */
.fsel {
  width: 100%; padding: 2px 4px; height: 24px; font-size: 11px;
  background: #15191f; border: 1px solid #444; border-radius: 3px; color: #ddd;
}
.fsel:focus { border-color: var(--primary); }

/* --- STATUS COLORS (COLOR CODE) --- */
.status-select {
  height: 22px; padding: 0 4px; font-size: 11px; width: 100%; border-radius: 3px;
  font-weight: 700; border: 1px solid transparent;
}

/* WIP - Green */
.status-select[data-status="WIP"], option[value="WIP"] { 
  background: rgba(46, 204, 113, 0.15) !important; 
  color: #2ecc71 !important; 
  border-color: #2ecc71 !important; 
}
/* YTI - Gold/Yellow */
.status-select[data-status="YTI"], option[value="YTI"] { 
  background: rgba(241, 196, 15, 0.15) !important; 
  color: #f1c40f !important; 
  border-color: #f1c40f !important; 
}
/* Hold - Purple/Blue */
.status-select[data-status="Hold"], option[value="Hold"] { 
  background: rgba(155, 89, 182, 0.15) !important; 
  color: #9b59b6 !important; 
  border-color: #9b59b6 !important; 
}
/* Closed - Red */
.status-select[data-status="Closed"], option[value="Closed"] { 
  background: rgba(231, 76, 60, 0.15) !important; 
  color: #e74c3c !important; 
  border-color: #e74c3c !important; 
}

/* --- 4. Footer --- */
.card-foot {
  padding: 8px; text-align: center; font-size: 11px; color: #888;
  border-top: 1px solid var(--border); background: var(--card-bg);
  flex-shrink: 0;
}

/* Toast */
.toast {
  position: fixed; bottom: 20px; right: 20px;
  background: #111; color: var(--primary); border: 1px solid var(--primary);
  padding: 8px 16px; border-radius: 6px; z-index: 1000;
  opacity: 0; transition: opacity 0.3s; pointer-events: none; font-size: 12px;
  box-shadow: 0 5px 15px rgba(0,0,0,0.5);
}
.toast.show { opacity: 1; }
</style>

<div class="wrap" id="mainWrap">
  <div class="card">
    
    <!-- Fixed Top Section -->
    <div class="top-section">
      <div class="header-row">
        <a href="{{ url_for('dashboard') }}" class="back">&larr; Back to Dashboard</a>
        <h1>Allocations (Project Codes)</h1>
      </div>

      {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
          <div class="flash-container">
            {% for cat, msg in messages %}
              <span class="flash {{ cat }}">{{ msg }}</span>
            {% endfor %}
          </div>
        {% endif %}
      {% endwith %}

      <!-- Add/Update Form -->
      <form method="post" class="form-grid" autocomplete="off" id="codeForm">
        <div class="fg">
          <label>Project</label>
          <input type="text" id="project" name="project" placeholder="Project Name" required>
        </div>
        <div class="fg">
          <label>Type</label>
          <input type="text" id="ptype" name="ptype" placeholder="Project Type" required>
        </div>
        
        {% if team not in ["IPTeam","MRTeam","BDTeam","AnalyticsTeam"] %}
        <div class="fg">
          <label>Disease</label>
          <input type="text" id="country" name="country" placeholder="Disease">
        </div>
        <div class="fg">
          <label>Country</label>
          <input type="text" id="disease" name="disease" placeholder="Country">
        </div>
        {% endif %}

        <div class="fg" style="flex: 1.5;">
          <label>Generated Code</label>
          <input type="text" id="code" name="code" readonly placeholder="Auto-generated...">
        </div>

        <div class="fg">
          <label>Status</label>
          <select name="status" class="status-select" data-status="YTI">
            <option value="YTI" selected>YTI</option>
            <option value="WIP">WIP</option>
            <option value="Hold">Hold</option>
            <option value="Closed">Closed</option>
          </select>
        </div>

        <div class="fg">
          <label>&nbsp;</label>
          <button class="btn-yellow" type="submit" style="width:100%">Save Code</button>
        </div>
      </form>
    </div>

    <!-- Scrollable Table -->
    <div class="table-wrap">
      <table id="codesTable">
        <!-- Standard Column Widths (Perfectly Fitted) -->
        <colgroup>
          <col style="width: 40px;">  <!-- # Small -->
          <col style="width: 100px;">  <!-- Project Code (Fills space) -->
          <col style="width: 100px;"> <!-- Status -->
          <col style="width: 100px;"> <!-- Team -->
          <col style="width: 50px;"> <!-- Start -->
          <col style="width: 50px;"> <!-- End/Hold -->
          <col style="width: 50px;"> <!-- YTI->WIP -->
        </colgroup>
        <thead>
          <tr>
            <th style="text-align:center;">#</th>
            <th>Project Code</th>
            <th>Status</th>
            <th>Team</th>
            <th>Start Date</th>
            <th>End / Hold Date</th>
            <th>YTI → WIP</th>
          </tr>
          <!-- Filter Row -->
          <tr class="filters-row">
            <th></th>
            <th><select data-col="1" class="fsel"><option value="">All</option></select></th>
            <th>
              <select data-col="2" class="fsel">
                <option value="">All</option>
                <option>WIP</option>
                <option>YTI</option>
                <option>Hold</option>
                <option>Closed</option>
              </select>
            </th>
            <th><select data-col="3" class="fsel"><option value="">All</option></select></th>
            <th><select data-col="4" class="fsel"><option value="">All</option></select></th>
            <th>
              <div style="display:flex; gap:5px; align-items:center;">
                <select data-col="5" class="fsel" style="width:100%;"><option value="">All</option></select>
                <button type="button" id="resetFilters" class="btn-ghost">X</button>
              </div>
            </th>
            <th><select data-col="6" class="fsel"><option value="">All</option></select></th>
          </tr>
        </thead>

        <tbody>
          {% for r in rows %}
          <tr data-id="{{ r.id }}">
            <td class="col-idx" style="text-align:center;">{{ loop.index }}</td>
            <td class="col-code" style="font-weight:500; color:#fff;" title="{{ r.code }}">{{ r.code if r.code else '' }}</td>
            <td class="col-status">
              <select class="status-select" data-status="{{ r.status }}">
                <option value="WIP" {{ 'selected' if r.status=='WIP' else '' }}>WIP</option>
                <option value="YTI" {{ 'selected' if r.status=='YTI' else '' }}>YTI</option>
                <option value="Hold" {{ 'selected' if r.status=='Hold' else '' }}>Hold</option>
                <option value="Closed" {{ 'selected' if r.status=='Closed' else '' }}>Closed</option>
              </select>
            </td>
            <td class="col-team">{{ r.team or '' }}</td>
            <td class="col-start">{{ r.start_date.strftime('%d-%m-%Y') if r.start_date else '' }}</td>
            <td class="col-endhold">
              {% if r.status == 'Closed' and r.end_date %}
                {{ r.end_date.strftime('%d-%m-%Y') }}
              {% elif r.status == 'Hold' and r.hold_on %}
                <span style="color:#aaa; font-size:10px;">Hold:</span> {{ r.hold_on.strftime('%d-%m-%Y') }}
              {% endif %}
            </td>
            <td class="col-ytiend">{{ r.yti_end_date.strftime('%d-%m-%Y') if r.yti_end_date else '' }}</td>
          </tr>
          {% else %}
          <tr><td colspan="7" style="text-align:center; padding:30px; color:#777;">No project codes found.</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <!-- Footer -->
    <div class="card-foot">
      © 2025 Datasolve Analytics — All Rights Reserved
    </div>
  </div>
</div>

<div id="toast" class="toast"></div>

<!-- Scripts -->
<script>
// 1. Sidebar Auto-Adjust (Universal)
function checkSidebarAndAdjust() {
  const wrap = document.getElementById('mainWrap');
  let sidebarWidth = 0;
  const potentialSidebars = document.querySelectorAll('nav, aside, .sidebar, #sidebar, .sidenav');
  for (let el of potentialSidebars) {
    const rect = el.getBoundingClientRect();
    if (rect.left === 0 && rect.width > 0 && rect.height > 500) sidebarWidth = Math.max(sidebarWidth, rect.width);
  }
  const bodyStyle = window.getComputedStyle(document.body);
  const marginLeft = parseInt(bodyStyle.marginLeft);
  if (marginLeft > 0) sidebarWidth = Math.max(sidebarWidth, marginLeft);

  if (sidebarWidth > 100) wrap.style.marginLeft = (sidebarWidth + 10) + 'px';
  else wrap.style.marginLeft = (sidebarWidth > 0 ? sidebarWidth + 10 : 80) + 'px';
}
setInterval(checkSidebarAndAdjust, 300);
window.addEventListener('load', checkSidebarAndAdjust);
window.addEventListener('resize', checkSidebarAndAdjust);

// 2. Table Logic (Filters, Status Update)
document.addEventListener("DOMContentLoaded", function(){
  const table = document.getElementById('codesTable');
  const tbody = table.querySelector('tbody');
  const filterSelects = table.querySelectorAll('.filters-row .fsel');
  
  const showToast = (msg) => {
    const t = document.getElementById('toast');
    t.textContent = msg;
    t.classList.add('show');
    setTimeout(()=> t.classList.remove('show'), 2000);
  };

  // Update Status Color Immediately on Change
  tbody.addEventListener('change', async (e) => {
    if (!e.target.classList.contains('status-select')) return;
    const select = e.target;
    const tr = select.closest('tr');
    const theId = tr.dataset.id;
    const newStatus = select.value;

    // Update Color Immediately
    select.setAttribute('data-status', newStatus);

    try {
      const res = await fetch('{{ url_for("update_project_status") }}', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ id: theId, status: newStatus })
      });
      const data = await res.json();
      if (!res.ok || !data.ok) throw new Error(data.message || 'Update failed');

      tr.querySelector('.col-start').textContent = data.start_date || '';
      
      let endHoldText = '';
      if (newStatus === 'Closed' && data.end_date) endHoldText = data.end_date;
      else if (newStatus === 'Hold' && data.hold_on) endHoldText = 'Hold: ' + data.hold_on;
      else endHoldText = '';
      
      tr.querySelector('.col-endhold').innerHTML = endHoldText;
      tr.querySelector('.col-ytiend').textContent = data.yti_end_date || '';

      showToast('Status Updated!');
    } catch (err) {
      console.error(err);
      showToast('Update Failed!');
    }
  });

  // Add Status Color Change listener for the MAIN FORM too
  const formStatusSelect = document.querySelector('#codeForm select[name="status"]');
  if(formStatusSelect) {
    formStatusSelect.addEventListener('change', function() {
      this.setAttribute('data-status', this.value);
    });
    // Init color
    formStatusSelect.setAttribute('data-status', formStatusSelect.value);
  }

  // Table Filtering Logic
  function cellText(tr, idx){
    if(idx === 2) return tr.querySelector('.status-select').value; 
    return (tr.cells[idx].textContent || '').trim();
  }

  function buildDropdowns(){
    const cols = [[],[],[],[],[],[],[]];
    Array.from(tbody.rows).forEach(tr=>{
      [1,3,4,5,6].forEach(i=> cols[i].push(cellText(tr,i))); 
    });

    filterSelects.forEach(sel=>{
      const col = parseInt(sel.dataset.col,10);
      const current = sel.value;
      if ([1,3,4,5,6].includes(col)) {
        sel.innerHTML = '<option value="">All</option>';
        [...new Set(cols[col].filter(Boolean))].sort().forEach(v=>{
          const o = document.createElement('option');
          o.value = v; o.textContent = v;
          sel.appendChild(o);
        });
        if ([...sel.options].some(o=>o.value===current)) sel.value = current;
      }
    });
  }

  function applyFilters(){
    const filters = Array.from(filterSelects).reduce((a,el)=>{ a[el.dataset.col]=el.value; return a; }, {});
    Array.from(tbody.rows).forEach(tr=>{
      let visible = true;
      for (const [k,val] of Object.entries(filters)){
        if (!val) continue;
        const idx = parseInt(k,10);
        if (cellText(tr, idx) !== val) { visible = false; break; }
      }
      tr.style.display = visible ? '' : 'none';
    });
  }

  filterSelects.forEach(s=> s.addEventListener('change', applyFilters));
  document.getElementById('resetFilters').addEventListener('click', ()=>{
    filterSelects.forEach(s=> s.value='');
    applyFilters();
  });

  buildDropdowns();

  // Code Generation
  const project = document.getElementById("project");
  const ptype   = document.getElementById("ptype");
  const country = document.getElementById("country");
  const disease = document.getElementById("disease");
  const code    = document.getElementById("code");
  const team    = "{{ team|default('', true) }}";
  const disableTeams = ["IPTeam","MRTeam","BDTeam","AnalyticsTeam"];

  if (disableTeams.includes(team)) {
    if (country) { country.value = ""; country.disabled = true; }
    if (disease) { disease.value = ""; disease.disabled = true; }
  }

  function buildCode() {
    const proj = project.value.trim();
    const pt   = ptype.value.trim();
    const ct   = country ? country.value.trim() : "";
    const ds   = disease ? disease.value.trim() : "";

    let finalCode = "";
    if (team === "MCTeam") {
      if (proj && pt && ct && ds) finalCode = `${proj}_${pt}_${ct}_${ds}`;
    } else if (disableTeams.includes(team)) {
      if (proj && pt) finalCode = `${proj}_${pt}`;
    } else {
      if (proj && pt) finalCode = `${proj}_${pt}${ct ? "_" + ct : ""}${ds ? "_" + ds : ""}`;
    }
    code.value = finalCode;
  }

  [project, ptype].forEach(el => el.addEventListener("input", buildCode));
  if (country) country.addEventListener("input", buildCode);
  if (disease) disease.addEventListener("input", buildCode);
});
</script>
{% endblock %}