{% extends "base.html" %}
{% block title %}Logsy - Process & Sub-Process{% endblock %}

{% block content %}
<style>
/* --- Theme Variables --- */
:root{
  --primary:#ffd24d; --primary-hover:#e6bc46;
  --accent:#2ecc71;  --warning:#ffb037;
  --danger:#e74c3c;
  --bg:#0f151d;      --card-bg:#30363d;
  --head-grad:linear-gradient(135deg,#ffd24d 0%,#ffdb6e 100%);
  --border:#1e242d;  --row-hover:#232b35;
  --scroll-thumb:#8a8e96; --scroll-track:#1b212a;
}

/* 1. RESET & FIXED LAYOUT */
html, body { height: 100%; margin: 0; padding: 0; overflow: hidden; }

body {
  font-family: 'Segoe UI', Tahoma, Arial, sans-serif;
  background: var(--bg);
  color: #e5e7eb;
}

/* Wrapper - The Magic Container */
.wrap {
  /* Height: Fill vertical space minus headers */
  height: calc(100vh - 90px);
  
  /* WIDTH: Auto fills available space */
  width: auto; 
  
  /* DEFAULT PADDING */
  padding: 15px 20px;
  
  display: flex;
  flex-direction: column;
  
  /* Smooth animation when sidebar toggles */
  transition: margin-left 0.3s ease-in-out;
}

/* Card Container */
.card {
  background: var(--card-bg);
  border-radius: 12px;
  box-shadow: 0 14px 34px rgba(0,0,0,.25);
  display: flex;
  flex-direction: column;
  height: 100%; 
  overflow: hidden;
  padding: 0;
  width: 100%;
}

/* --- 2. Fixed Top Section (Header + Forms) --- */
.top-section {
  padding: 15px 20px;
  border-bottom: 1px solid var(--border);
  background: #252a30;
  flex-shrink: 0;
  display: flex;
  flex-direction: column;
  gap: 15px;
}

.header-row {
  display: flex; justify-content: space-between; align-items: center;
}

.back {
  color: var(--primary); font-weight: 600; text-decoration: none;
  font-size: 13px; transition: color .15s;
}
.back:hover { color: var(--primary-hover); }

h1 { margin: 0; font-size: 20px; color: #b8e4ff; line-height: 1; }

/* Add Form Grid */
.add-form {
  display: grid; gap: 10px;
  grid-template-columns: 1fr 1fr 1fr auto;
}

/* Filter Row Grid */
.filter-row {
  display: grid; gap: 10px;
  grid-template-columns: 1fr 1fr 1fr;
}

/* Inputs & Selects */
input, select {
  font-size: 13px; padding: 8px 12px; border-radius: 6px;
  border: 1px solid var(--border);
  background: #1c222b; color: #e5e7eb;
  width: 100%; box-sizing: border-box;
  outline: none;
}
input:focus, select:focus { border-color: var(--primary); }

button {
  padding: 8px 16px; border: none; border-radius: 6px;
  background: var(--primary); color: #050505; font-weight: 600; cursor: pointer;
  white-space: nowrap;
}
button:hover { background: var(--primary-hover); }

/* Flash Messages */
.flash-container { display: flex; gap: 10px; }
.flash { padding: 4px 10px; border-radius: 4px; font-size: 12px; font-weight: 600; }
.flash.ok { background: #e9f8f1; color: var(--accent); }
.flash.err { background: #fff4eb; color: var(--warning); }

/* --- 3. Table Area (Scrollable) --- */
.table-wrap {
  flex: 1;           
  overflow: auto;    
  position: relative;
  width: 100%;
}

/* Scrollbar Styling */
.table-wrap::-webkit-scrollbar { width: 6px; height: 6px; }
.table-wrap::-webkit-scrollbar-track { background: var(--scroll-track); }
.table-wrap::-webkit-scrollbar-thumb { background: var(--scroll-thumb); border-radius: 4px; }

table { 
  width: 100%; 
  border-collapse: separate; 
  border-spacing: 0; 
  font-size: 13px; 
  table-layout: fixed; /* Standardize Columns */
  min-width: 800px; 
}

/* Sticky Header */
th {
  background: var(--head-grad); color: #111; font-weight: 700;
  position: sticky; top: 0; z-index: 10;
  padding: 10px 14px; text-align: left;
  box-shadow: 0 2px 5px rgba(0,0,0,0.15);
  white-space: nowrap;
}

td {
  padding: 8px 14px; border-bottom: 1px solid var(--border);
  color: #ccc; vertical-align: middle;
}

tbody tr:nth-child(even) { background: #42484f; }
tbody tr:hover { background: var(--row-hover); }

/* Action Buttons */
.action-btns { display: flex; gap: 8px; }
.btn-sm {
  font-size: 11px; padding: 4px 10px; border-radius: 4px; border: none; cursor: pointer; font-weight: 600;
}
.edit-btn { background: #ffd24d; color: #222; }
.save-btn { background: #2ecc71; color: #fff; }
.cancel-btn { background: #ffb037; color: #222; }
.delete-btn { background: #e8493a; color: #fff; }

tr.editing td { background: #181b20; }

/* --- 4. Footer --- */
.card-foot {
  padding: 10px; text-align: center; font-size: 12px; color: #888;
  border-top: 1px solid var(--border); background: var(--card-bg);
  flex-shrink: 0;
}
</style>

<div class="wrap" id="mainWrap">
  <div class="card">
    
    <!-- Fixed Top Section -->
    <div class="top-section">
      <div class="header-row">
        <div>
          <a href="/home" class="back">&larr; Back to Dashboard</a>
          <h1>Process & Sub-Process</h1>
        </div>
        <div class="flash-container">
          {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
              {% for category, msg in messages %}
                <span class="flash {{ 'err' if category == 'error' else 'ok' }}">{{ msg }}</span>
              {% endfor %}
            {% endif %}
          {% endwith %}
        </div>
      </div>

      <!-- Add Form -->
      <form method="POST" action="{{ url_for('manage_process') }}" class="add-form">
        <input type="text" name="team" placeholder="Team" required>
        <input type="text" name="process" placeholder="Process" required>
        <input type="text" name="sub" placeholder="Sub-Process" required>
        <button type="submit">Add Row</button>
      </form>

      <!-- Filter Row -->
      <div class="filter-row">
        <select id="filter_team" onchange="filterTable()">
          <option value="">All Teams</option>
          {% for t in teams %}<option value="{{ t }}">{{ t }}</option>{% endfor %}
        </select>
        <select id="filter_process" onchange="filterTable()">
          <option value="">All Processes</option>
          {% for p in processes %}<option value="{{ p }}">{{ p }}</option>{% endfor %}
        </select>
        <select id="filter_sub" onchange="filterTable()">
          <option value="">All Sub-Processes</option>
          {% for s in sub_processes %}<option value="{{ s }}">{{ s }}</option>{% endfor %}
        </select>
      </div>
    </div>

    <!-- Scrollable Table Area -->
    <div class="table-wrap">
      <table id="processTable">
        <!-- Standard Column Widths -->
        <colgroup>
          <col style="width: 5%;">  <!-- ID -->
          <col style="width: 20%;"> <!-- Team -->
          <col style="width: 30%;"> <!-- Process -->
          <col style="width: 30%;"> <!-- Sub-Process -->
          <col style="width: 15%;"> <!-- Actions -->
        </colgroup>
        <thead>
          <tr>
            <th>ID</th>
            <th>Team</th>
            <th>Process</th>
            <th>Sub-Process</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for r in rows %}
          <tr data-team="{{ r.team }}" data-process="{{ r.process }}" data-sub="{{ r.sub_process }}">
            <td>{{ r.id }}</td>
            <td>{{ r.team }}</td>
            <td>{{ r.process }}</td>
            <td>{{ r.sub_process }}</td>
            <td>
              <div class="action-btns">
                <button class="btn-sm edit-btn" onclick="editRow(this)">Edit</button>
                <button class="btn-sm delete-btn" onclick="deleteRow(this, {{ r.id }})">Delete</button>
              </div>
            </td>
          </tr>
          {% else %}
          <tr><td colspan="5" style="text-align:center; padding:20px;">No records yet</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <!-- Footer -->
    <div class="card-foot">
      Â© Datasolve Analytics Pvt Ltd 2025.
    </div>
  </div>
</div>

<!-- JS Scripts -->
<script>
// 1. Sidebar Auto-Adjust Script (Same as User Management)
function checkSidebarAndAdjust() {
  const wrap = document.getElementById('mainWrap');
  let sidebarWidth = 0;
  const potentialSidebars = document.querySelectorAll('nav, aside, .sidebar, #sidebar, .sidenav');
  
  for (let el of potentialSidebars) {
    const rect = el.getBoundingClientRect();
    if (rect.left === 0 && rect.width > 0 && rect.height > 500) {
      sidebarWidth = Math.max(sidebarWidth, rect.width);
    }
  }

  const bodyStyle = window.getComputedStyle(document.body);
  const marginLeft = parseInt(bodyStyle.marginLeft);
  if (marginLeft > 0) sidebarWidth = Math.max(sidebarWidth, marginLeft);

  if (sidebarWidth > 100) {
     wrap.style.marginLeft = (sidebarWidth + 10) + 'px';
  } else {
     const safeMargin = sidebarWidth > 0 ? sidebarWidth + 10 : 80; 
     wrap.style.marginLeft = safeMargin + 'px';
  }
}

setInterval(checkSidebarAndAdjust, 300);
window.addEventListener('load', checkSidebarAndAdjust);
window.addEventListener('resize', checkSidebarAndAdjust);

// 2. Table Functions
function filterTable() {
  var team = document.getElementById("filter_team").value.toLowerCase();
  var process = document.getElementById("filter_process").value.toLowerCase();
  var sub = document.getElementById("filter_sub").value.toLowerCase();

  var rows = document.querySelectorAll("#processTable tbody tr");
  rows.forEach(row => {
    let match = true;
    if (team && row.dataset.team.toLowerCase() !== team) match = false;
    if (process && row.dataset.process.toLowerCase() !== process) match = false;
    if (sub && row.dataset.sub.toLowerCase() !== sub) match = false;
    row.style.display = match ? "" : "none";
  });
}

function editRow(btn) {
  var row = btn.closest('tr');
  if(row.classList.contains('editing')) return;
  row.classList.add('editing');
  let tds = row.querySelectorAll('td');
  let [id, team, process, sub] = [tds[0].innerText, tds[1].innerText, tds[2].innerText, tds[3].innerText];
  
  // Use input fields for editing
  tds[1].innerHTML = `<input value="${team}">`;
  tds[2].innerHTML = `<input value="${process}">`;
  tds[3].innerHTML = `<input value="${sub}">`;
  
  tds[4].innerHTML = `
    <div class="action-btns">
      <button class="btn-sm save-btn" onclick="saveRow(this,${id})">Save</button>
      <button class="btn-sm cancel-btn" onclick="cancelEdit(this,'${team}','${process}','${sub}')">Cancel</button>
      <button class="btn-sm delete-btn" onclick="deleteRow(this,${id})">Delete</button>
    </div>
  `;
}

function saveRow(btn, id) {
  var row = btn.closest('tr');
  let team = row.cells[1].querySelector('input').value;
  let process = row.cells[2].querySelector('input').value;
  let sub = row.cells[3].querySelector('input').value;
  
  fetch('/update_process_row', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({id, team, process, sub_process:sub})
  })
  .then(resp => resp.json())
  .then(data => {
    if(data.success){
      row.cells[1].innerText = team;
      row.cells[2].innerText = process;
      row.cells[3].innerText = sub;
      row.cells[4].innerHTML = `
        <div class="action-btns">
          <button class="btn-sm edit-btn" onclick="editRow(this)">Edit</button>
          <button class="btn-sm delete-btn" onclick="deleteRow(this,${id})">Delete</button>
        </div>
      `;
      row.classList.remove('editing');
      row.dataset.team = team;
      row.dataset.process = process;
      row.dataset.sub = sub;
    } else {
      alert(data.error || "Update failed");
    }
  });
}

function cancelEdit(btn, t, p, s){
  let row = btn.closest('tr');
  let id = row.cells[0].innerText;
  row.cells[1].innerText = t;
  row.cells[2].innerText = p;
  row.cells[3].innerText = s;
  row.cells[4].innerHTML = `
    <div class="action-btns">
      <button class="btn-sm edit-btn" onclick="editRow(this)">Edit</button>
      <button class="btn-sm delete-btn" onclick="deleteRow(this,${id})">Delete</button>
    </div>
  `;
  row.classList.remove('editing');
}

function deleteRow(btn, id) {
  if(!confirm("Are you sure you want to delete this row?")) return;
  var row = btn.closest('tr');
  fetch('/admin/delete_process_row', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({id: id})
  })
  .then(resp => resp.json())
  .then(data => {
    if(data.success){
      row.remove();
    } else {
      alert(data.error || "Delete failed");
    }
  });
}
</script>
{% endblock %}