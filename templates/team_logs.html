{% extends "base.html" %}
{% block title %}Team Timesheet Logs{% endblock %}

{% block content %}
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

<style>
  /* --- Professional Dark & Gold Theme --- */
  :root {
    --bg: #0a0a0a;            
    --card: #141414;          
    --card-border: #2a2a2a;   
    --text-main: #e0e0e0;
    --text-muted: #888;
    --gold: #FFD700;          
    --gold-dim: rgba(255, 215, 0, 0.1);
    --gold-hover: #e6c200;
    --input-bg: #1f1f1f;
    --input-border: #333;
    --danger: #ff4d4d;
    --success: #00cc66;
  }

  ::-webkit-scrollbar { width: 6px; height: 6px; }
  ::-webkit-scrollbar-track { background: var(--bg); }
  ::-webkit-scrollbar-thumb { background: #333; border-radius: 4px; border: 1px solid var(--bg); }
  ::-webkit-scrollbar-thumb:hover { background: var(--gold); }

  .wrap { 
    height: calc(100vh - 110px); 
    width: 98%; 
    margin: 10px auto; 
    display: flex; 
    flex-direction: column;
    overflow: hidden; 
  }
  
  .card {
    background: var(--card); 
    border: 1px solid var(--card-border);
    border-radius: 8px; 
    box-shadow: 0 10px 30px rgba(0,0,0,0.5);
    display: flex; 
    flex-direction: column; 
    height: 100%; 
    overflow: hidden; 
  }

  .head, .controls, .filter-bar, .pager { flex-shrink: 0; }

  .head {
    padding: 8px 15px; 
    border-bottom: 1px solid var(--card-border);
    background: #111;
    display: flex; align-items: center; justify-content: space-between;
  }
  .head h2 { margin: 0; color: var(--gold); font-weight: 700; font-size: 1rem; }

  .controls {
    padding: 8px 15px; 
    background: #0f0f0f;
    border-bottom: 1px solid var(--card-border);
    display: flex; gap: 15px; align-items: flex-end; flex-wrap: wrap;
  }
  .ctrl-grp { display: flex; flex-direction: column; gap: 4px; }
  .ctrl-grp label { font-size: 0.7rem; color: var(--text-muted); font-weight: 600; }

  .c-input, .f-select {
    background: var(--input-bg); border: 1px solid var(--input-border); color: #fff;
    padding: 2px 8px; border-radius: 4px; font-size: 0.8rem; height: 26px; outline: none;
    transition: border-color 0.2s; font-family: 'Inter', sans-serif;
  }
  .c-input:focus, .f-select:focus { border-color: var(--gold); box-shadow: 0 0 0 1px var(--gold-dim); }
  .c-input[type="date"]::-webkit-calendar-picker-indicator { filter: invert(1); opacity: 0.6; cursor: pointer; transform: scale(0.8); }

  .btn-gold {
    background: var(--gold); color: #000; border: none; font-weight: 600;
    padding: 0 12px; border-radius: 4px; cursor: pointer; transition: 0.2s;
    font-size: 0.8rem; height: 26px; display: inline-flex; align-items: center;
  }
  .btn-gold:hover { background: var(--gold-hover); }

  .btn-outline {
    background: transparent; color: var(--gold); border: 1px solid var(--gold);
    padding: 0 10px; border-radius: 4px; cursor: pointer; font-weight: 600; transition: 0.2s;
    text-decoration: none; display: inline-flex; align-items: center; font-size: 0.8rem; height: 26px;
  }
  .btn-outline:hover { background: var(--gold-dim); }

  .filter-bar {
    padding: 6px 15px; background: #161616; border-bottom: 1px solid var(--card-border);
    display: grid; grid-template-columns: repeat(auto-fit, minmax(130px, 1fr)); gap: 10px; align-items: center;
  }
  .f-select { width: 100%; min-width: 0; } 

  .table-wrap { flex: 1; overflow: auto; position: relative; background: #0a0a0a; }

  table { width: 100%; border-collapse: separate; border-spacing: 0; table-layout: fixed; }

  thead th {
    position: sticky; top: 0; z-index: 30;
    background-color: var(--gold); color: #000; 
    font-weight: 700; font-size: 0.75rem; text-transform: capitalize; 
    padding: 8px 10px; text-align: left;
    border-bottom: 2px solid #000;
    white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
  }

  tbody td:first-child {
    position: sticky; left: 0; z-index: 20;
    background-color: #111; border-right: 1px solid #333;
    color: #fff; font-weight: 600;
  }
  thead th:first-child { z-index: 40; left: 0; border-right: 1px solid #000; }

  tbody tr { background: #111; transition: background 0.15s; }
  tbody tr:nth-child(even) { background: #161616; }
  tbody tr:nth-child(even) td:first-child { background: #161616; }
  tbody tr:hover td { background: #1f1f1f; color: #fff; }
  tbody tr:hover td:first-child { background: #1f1f1f; }

  tbody td {
    padding: 4px 10px; border-bottom: 1px solid #222;
    font-size: 0.8rem; color: #ccc; vertical-align: middle;
  }

  .truncate { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; display: block; }

  tr.editing td { background: #262626 !important; border-bottom: 1px solid var(--gold); }
  tr.editing td:first-child { background: #262626 !important; border-right: 1px solid var(--gold); }
  
  .t-input, .t-select {
    width: 100%; background: #000; border: 1px solid #444; color: #fff;
    padding: 2px 4px; border-radius: 4px; font-size: 0.8rem; outline: none; height: 24px;
  }
  .t-input:focus, .t-select:focus { border-color: var(--gold); }

  .badge-btn {
    display: inline-block; padding: 2px 8px; border-radius: 12px;
    font-size: 0.7rem; font-weight: 600; text-decoration: none; cursor: pointer;
    border: 1px solid #333; background: #222; color: #bbb;
  }
  .badge-btn:hover { border-color: var(--gold); color: var(--gold); background: #2a2a2a; }
  .badge-del { border-color: #522; color: #e55; background: #2a1a1a; }
  .badge-del:hover { border-color: #f44; color: #fff; background: #822; }

  .action-group { display: flex; gap: 4px; justify-content: center; }
  .btn-save-sm { background: var(--gold); color: #000; border: none; padding: 2px 8px; border-radius: 4px; font-weight: 700; cursor: pointer; font-size: 0.75rem; }
  .btn-cancel-sm { border: 1px solid #555; color: #aaa; background: transparent; padding: 2px 8px; border-radius: 4px; cursor: pointer; font-size: 0.75rem; }
  .btn-cancel-sm:hover { color: #fff; border-color: #fff; }

  .pager {
    padding: 8px 15px; background: #0f0f0f; border-top: 1px solid #333;
    display: flex; justify-content: space-between; align-items: center; 
    font-size: 0.75rem; color: #888;
  }
  .pager-btns button {
    background: #222; border: 1px solid #333; color: #fff;
    padding: 3px 10px; border-radius: 4px; cursor: pointer; margin-left: 5px; font-size: 0.75rem;
  }
  .pager-btns button:hover:not(:disabled) { border-color: var(--gold); color: var(--gold); }

  .flash-container { position: fixed; top: 60px; left: 50%; transform: translateX(-50%); z-index: 2000; display: flex; flex-direction: column; gap: 10px; width: 300px; }
  .flash { padding: 8px 12px; border-radius: 6px; font-weight: 600; box-shadow: 0 4px 15px rgba(0,0,0,0.6); text-align: center; font-size: 0.85rem; }
  .flash-success { background: var(--success); color: #000; }
  .flash-error { background: var(--danger); color: #fff; }
</style>

<div class="wrap">
  <div class="flash-container">
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        {% for cat, msg in messages %}
          <div class="flash flash-{{ 'success' if cat=='success' else 'error' }}">{{ msg }}</div>
        {% endfor %}
      {% endif %}
    {% endwith %}
  </div>

  <div class="card">
    <div class="head">
      <h2>Team Logsy Logs</h2>
    </div>

    <form method="POST" id="filterForm">
      <input type="hidden" name="page" id="pageInput" value="{{ page|default(1) }}">
      
      <input type="hidden" name="editing_id" id="editingIdInput" value="{{ editing_id or '' }}">

      <div class="controls">
        <div class="ctrl-grp">
          <label>Start Date</label>
          <input type="date" name="start_date" class="c-input" value="{{ request.form.start_date or '' }}">
        </div>
        <div class="ctrl-grp">
          <label>End Date</label>
          <input type="date" name="end_date" class="c-input" value="{{ request.form.end_date or '' }}">
        </div>
        <div class="ctrl-grp">
          <label>Rows</label>
          <select name="per_page" class="c-input" onchange="this.form.submit()" style="min-width: 60px;">
            <option value="50" {% if per_page == 50 %}selected{% endif %}>50</option>
            <option value="100" {% if per_page == 100 %}selected{% endif %}>100</option>
            <option value="200" {% if per_page == 200 %}selected{% endif %}>200</option>
          </select>
        </div>
        
        <div style="margin-left: auto; display: flex; gap: 8px;">
           <button type="submit" class="btn-gold">Apply</button>
           <a href="{{ url_for('view_team_logs') }}" class="btn-outline">Reset</a>
           <a href="{{ url_for('live_status') }}" class="btn-outline">Live</a>
        </div>
      </div>

      <div class="filter-bar">
        {% if role == 'superadmin' %}
          <select name="team" class="f-select" onchange="this.form.submit()">
             <option value="">All Teams</option>
             {% for t in teams %}
               <option value="{{ t }}" {% if selected_team == t %}selected{% endif %}>{{ t }}</option>
             {% endfor %}
          </select>
        {% endif %}

        <select name="username" class="f-select" onchange="this.form.submit()">
           <option value="">All Users</option>
           {% for u in users %}
             <option value="{{ u.username }}" {% if request.form.username == u.username %}selected{% endif %}>{{ u.username }}</option>
           {% endfor %}
        </select>

        <select name="project" class="f-select" onchange="this.form.submit()">
           <option value="">All Projects</option>
           {% for p in projects %}
             <option value="{{ p }}" {% if request.form.project == p %}selected{% endif %}>{{ p }}</option>
           {% endfor %}
        </select>

        <select name="process" class="f-select" onchange="this.form.submit()">
           <option value="">All Processes</option>
           {% for pr in processes %}
             <option value="{{ pr }}" {% if request.form.process == pr %}selected{% endif %}>{{ pr }}</option>
           {% endfor %}
        </select>

        <select name="sub_process" class="f-select" onchange="this.form.submit()">
           <option value="">All Sub-Processes</option>
           {% for sp in sub_processes %}
             <option value="{{ sp }}" {% if request.form.sub_process == sp %}selected{% endif %}>{{ sp }}</option>
           {% endfor %}
        </select>
      </div>
    </form>

    <div class="table-wrap">
      
      {% if editing_id %}
        <form id="editRowForm" method="POST" action="{{ url_for('update_entry') }}">
          <input type="hidden" name="entry_id" value="{{ editing_id }}">
          <input type="hidden" name="next" value="">
        </form>
      {% endif %}

      <table>
        <colgroup>
          <col style="width: 140px;"> <col style="width: 80px;">  <col style="width: 90px;">  <col style="width: 120px;"> <col style="width: 180px;"> <col style="width: 130px;"> <col style="width: 130px;"> <col style="width: 60px;">  <col style="width: 60px;">  <col style="width: 50px;">  <col style="width: 100px;"> </colgroup>

        <thead>
          <tr>
            <th>Name</th>
            <th>Team</th>
            <th>Date</th>
            <th>Work Type</th> <th>Project</th>
            <th>Process</th>
            <th>Sub-Process</th>
            <th>Start</th>
            <th>End</th>
            <th>Dur.</th>
            <th style="text-align: center;">Action</th>
          </tr>
        </thead>
        <tbody>
          {% for row in logs %}
            {% set row_id = row[11] %}
            {% set work_type = row[12] %}
            
            {% set is_edit = (editing_id == row_id|string) %}
            
            {% if is_edit %}
              <tr class="editing">
                <td style="font-weight: 700;">{{ row[0] }}</td>
                <td>{{ row[4] }}</td>
                <td>{{ row[1] }}</td>
                
                <td>
                    <select name="work_type" form="editRowForm" class="t-select">
                        <option value="Regular" {% if work_type == 'Regular' %}selected{% endif %}>Regular</option>
                        <option value="Additional Hours" {% if work_type == 'Additional Hours' %}selected{% endif %}>Additional Hours</option>
                        <option value="Compensation" {% if work_type == 'Compensation' %}selected{% endif %}>Compensation</option>
                    </select>
                </td>

                <td>
                  <select name="project" form="editRowForm" class="t-select" required>
                    <option value="{{ row[3] }}" selected>{{ row[3] }}</option>
                    {% for p in projects %}
                        {% if p != row[3] %}<option value="{{ p }}">{{ p }}</option>{% endif %}
                    {% endfor %}
                  </select>
                </td>
                
                <td>
                  <select name="process" form="editRowForm" class="t-select" required>
                    <option value="{{ row[5] }}" selected>{{ row[5] }}</option>
                    {% for pr in processes %}
                        {% if pr != row[5] %}<option value="{{ pr }}">{{ pr }}</option>{% endif %}
                    {% endfor %}
                  </select>
                </td>

                <td>
                  <select name="sub_process" form="editRowForm" class="t-select" required>
                    <option value="{{ row[6] }}" selected>{{ row[6] }}</option>
                    {% for sp in sub_processes %}
                        {% if sp != row[6] %}<option value="{{ sp }}">{{ sp }}</option>{% endif %}
                    {% endfor %}
                  </select>
                </td>

                <td><input type="time" name="start_time" form="editRowForm" value="{{ row[7] }}" class="t-input"></td>
                <td><input type="time" name="end_time" form="editRowForm" value="{{ row[8] }}" class="t-input"></td>
                <td>{{ row[9] }}</td>

                <td style="text-align: center;">
                   <div class="action-group">
                     <button type="submit" form="editRowForm" class="btn-save-sm">Save</button>
                     <button type="button" class="btn-cancel-sm" onclick="cancelEdit()">Cancel</button>
                   </div>
                </td>
              </tr>
            {% else %}
              <tr>
                <td title="{{ row[0] }}">{{ row[0] }}</td>
                <td title="{{ row[4] }}" style="color: #999;">{{ row[4] }}</td>
                <td title="{{ row[1] }}">{{ row[1] }}</td>
                
                <td>
                    {% if work_type == 'Regular' or not work_type %}
                        <span style="color: var(--gold); font-size: 0.75rem;">REG</span>
                    {% elif work_type == 'Additional Hours' %}
                        <span style="color: var(--success); font-size: 0.75rem;">ADD+</span>
                    {% elif work_type == 'Compensation' %}
                        <span style="color: #3b82f6; font-size: 0.75rem;">COMP</span>
                    {% else %}
                        {{ work_type }}
                    {% endif %}
                </td>

                <td title="{{ row[3] }}">
                  <span class="truncate" style="color: #fff; font-weight: 500;">{{ row[3] }}</span>
                </td>
                <td title="{{ row[5] }}">
                  <span class="truncate">{{ row[5] }}</span>
                </td>
                <td title="{{ row[6] }}">
                  <span class="truncate">{{ row[6] }}</span>
                </td>
                
                <td>{{ row[7] }}</td>
                <td>{{ row[8] }}</td>
                <td style="color: var(--gold);">{{ row[9] }}</td>
                <td style="text-align: center;">
                   <div class="action-group">
                     <button type="button" onclick="triggerEdit('{{ row_id }}')" class="badge-btn">Edit</button>
                     {% if role == 'superadmin' %}
                       <form action="{{ url_for('delete_log', log_id=row_id) }}" method="POST" style="display:inline;" onsubmit="return confirm('Permanently delete this entry?')">
                         <button type="submit" class="badge-btn badge-del">Del</button>
                       </form>
                     {% endif %}
                   </div>
                </td>
              </tr>
            {% endif %}
          {% endfor %}
          
          {% if logs|length == 0 %}
             <tr><td colspan="11" style="text-align:center; padding: 60px; color: #555;">No records found matching your filters.</td></tr>
          {% endif %}
        </tbody>
      </table>
    </div>

    <div class="pager">
       <div>Showing page <strong>{{ page }}</strong> of <strong>{{ total_pages }}</strong> ({{ total_rows }} total entries)</div>
       <div>Â© Datasolve Analytics Pvt Ltd 2025.</div>
       <div class="pager-btns">
          <button id="prevBtn" {% if page <= 1 %}disabled{% endif %}>Previous</button>
          <button id="nextBtn" {% if page >= total_pages %}disabled{% endif %}>Next</button>
       </div>
    </div>
  </div>
</div>

<script>
  // Pagination
  const filterForm = document.getElementById('filterForm');
  const pageInput = document.getElementById('pageInput');
  const editingIdInput = document.getElementById('editingIdInput');
  const totalPages = {{ total_pages }};

  document.getElementById('prevBtn')?.addEventListener('click', () => {
    let p = parseInt(pageInput.value) || 1;
    if(p > 1) { pageInput.value = p - 1; filterForm.submit(); }
  });

  document.getElementById('nextBtn')?.addEventListener('click', () => {
    let p = parseInt(pageInput.value) || 1;
    if(p < totalPages) { pageInput.value = p + 1; filterForm.submit(); }
  });

  // ðŸš€ FIX: Edit Handlers now SUBMIT the filter form
  // This preserves the selected Date, Team, User, etc.
  function triggerEdit(id) {
    editingIdInput.value = id; // Set the hidden ID field
    filterForm.submit();       // Submit the main form (POST)
  }

  function cancelEdit() {
    editingIdInput.value = ''; // Clear the hidden ID
    filterForm.submit();       // Submit to reload list without edit mode
  }

  // Handle "Save" redirection to keep filters (optional, but good UX)
  const editForm = document.getElementById('editRowForm');
  if(editForm){
     // Note: Since saving is a separate POST action, we can't easily preserve filters 
     // unless we pass them all to the update endpoint. 
     // For now, we redirect to base URL on save, which is standard behavior.
     // If you want to keep filters after save, backend needs to handle redirection params.
     // Current 'next' input logic handles basic return.
     const url = new URL(window.location.href);
     // We remove editing_id so it doesn't reopen edit mode after save
     editForm.querySelector('input[name="next"]').value = url.pathname; 
  }

  setTimeout(() => {
    const flashes = document.querySelector('.flash-container');
    if(flashes) {
        flashes.style.transition = "opacity 0.5s ease";
        flashes.style.opacity = 0;
        setTimeout(() => flashes.remove(), 500);
    }
  }, 4000);
</script>
{% endblock %}